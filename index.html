<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kynay AI - Your Professional Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Desain ala ChatGPT: Fokus pada Clean, Minimalist, dan Modern */
        :root {
            --bg-color: #202123; /* Dark background */
            --chat-bg-color: #343541; /* Slightly lighter chat background */
            --input-bg-color: #40414F; /* Input area background */
            --text-color: #ECECF1; /* Light text color */
            --placeholder-color: #8E8EA0; /* Placeholder text */
            --primary-button-color: #1A7F64; /* Green send button (ChatGPT inspired) */
            --primary-button-hover: #176B5A;
            --border-color: rgba(255, 255, 255, 0.1); /* Subtle borders */
            --message-user-bg: #32353E; /* User message background */
            --message-ai-bg: #444654; /* AI message background */
            --message-border-radius: 0.75rem; /* Rounded corners */
            --avatar-size: 2.25rem; /* Avatar size */
            --padding-base: 1rem; /* Base padding unit */
            --font-family: 'Inter', sans-serif;
            --typing-indicator-color: #555; /* Typing indicator dots */
        }

        /* Global Styles */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent global scrolling */
            overscroll-behavior: none; /* Prevent pull-to-refresh */
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            flex-direction: column; /* For mobile, to stack content vertically */
        }

        /* Loading Screen - Minimalist and Professional */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1.5s ease-out, visibility 1.5s ease-out;
            visibility: visible;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            font-family: var(--font-family);
            font-size: 5em; /* Larger, but not too big */
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 20px;
            animation: pulse 2s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .loading-text {
            font-size: 1.2em;
            color: var(--placeholder-color);
            opacity: 0;
            animation: fadeInText 1s forwards 0.5s;
        }

        @keyframes fadeInText {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Main Container */
        .container {
            background-color: var(--chat-bg-color);
            border-radius: var(--message-border-radius);
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.4);
            width: 95%;
            max-width: 900px; /* Standard web app width */
            height: 90vh; /* Takes most of the viewport height */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            animation: containerFadeIn 1s ease-out forwards 1.8s; /* Appears after loading */
        }

        @keyframes containerFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            background-color: var(--input-bg-color);
            color: var(--text-color);
            padding: var(--padding-base) calc(var(--padding-base) * 1.5);
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative; /* For the "New Chat" button */
        }
        .header h1 {
            margin: 0;
            font-size: inherit;
        }

        .clear-chat-button {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .clear-chat-button:hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .clear-chat-button svg {
            fill: currentColor; /* Use current text color */
            width: 1rem;
            height: 1rem;
        }

        /* Chat Window (Scrollable area) */
        .chat-window {
            flex-grow: 1; /* Takes available space */
            padding: var(--padding-base) calc(var(--padding-base) * 1.5);
            overflow-y: auto; /* Essential for scrolling */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Space between messages */
            scroll-behavior: smooth;
            font-size: 1.05em;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: var(--placeholder-color) var(--chat-bg-color);
        }
        .chat-window::-webkit-scrollbar {
            width: 0.5rem;
        }
        .chat-window::-webkit-scrollbar-track {
            background: var(--chat-bg-color);
        }
        .chat-window::-webkit-scrollbar-thumb {
            background-color: var(--placeholder-color);
            border-radius: 0.25rem;
            border: 2px solid var(--chat-bg-color);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background-color: var(--message-ai-bg);
            color: var(--text-color);
            border-radius: var(--message-border-radius);
            max-width: fit-content;
            font-size: 0.9em;
            animation: messageFadeIn 0.3s ease-out;
        }
        .typing-indicator .dot {
            width: 0.5rem;
            height: 0.5rem;
            background-color: var(--typing-indicator-color);
            border-radius: 50%;
            opacity: 0.7;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-0.25rem); }
        }

        /* Message Structure */
        .message {
            display: flex;
            gap: 0.75rem;
            animation: messageFadeIn 0.3s ease-out;
            align-items: flex-start; /* Align avatar and content to the top */
        }
        @keyframes messageFadeIn {
            from { opacity: 0; transform: translateY(0.5rem); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        /* Avatar */
        .avatar {
            width: var(--avatar-size);
            height: var(--avatar-size);
            border-radius: 0.25rem; /* Square avatar like ChatGPT */
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 1em;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .message.ai .avatar { background-color: #19C37D; color: white; } /* ChatGPT green */
        .message.user .avatar { background-color: #555663; color: white; } /* Darker user avatar */

        /* Message Content */
        .message-content {
            padding: 0.75rem 1rem;
            border-radius: var(--message-border-radius);
            max-width: 75%; /* Limit message width */
            word-wrap: break-word;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            display: flex; /* For image + text */
            flex-direction: column;
            gap: 0.5rem; /* Space between image and text */
        }
        .message.user .message-content {
            background-color: var(--message-user-bg);
        }
        .message.ai .message-content {
            background-color: var(--message-ai-bg);
        }
        .message-content p {
            margin: 0;
            padding: 0;
        }

        /* Images in messages */
        .message-image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem; /* Space between image and text */
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Attribution below AI messages */
        .message.ai .attribution {
            font-size: 0.75em;
            color: var(--placeholder-color);
            margin-top: 0.5rem;
            text-align: right; /* Align to the right for AI messages */
            opacity: 0.8;
        }


        /* Input Area */
        .input-area {
            display: flex;
            padding: var(--padding-base) calc(var(--padding-base) * 1.5);
            gap: 0.75rem;
            align-items: flex-end; /* Align items to the bottom, useful for multiline input */
            background-color: var(--input-bg-color);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--message-border-radius);
            font-size: 1em;
            background-color: var(--chat-bg-color);
            color: var(--text-color);
            outline: none;
            resize: none; /* Prevent manual resize */
            min-height: 2.75rem; /* Minimum height for single line */
            max-height: 10rem; /* Max height before scrolling input */
            overflow-y: auto; /* Allow input to scroll vertically */
            box-sizing: border-box; /* Include padding and border in width/height */
            line-height: 1.5;
            scrollbar-width: none; /* Hide scrollbar for textarea */
            -ms-overflow-style: none; /* IE and Edge */
        }
        .input-area textarea::-webkit-scrollbar {
            display: none; /* Hide scrollbar for webkit browsers */
        }

        .input-area textarea::placeholder {
            color: var(--placeholder-color);
        }
        .input-area textarea:focus {
            border-color: var(--primary-button-color);
            box-shadow: 0 0 0 2px rgba(26, 127, 100, 0.5); /* Focus glow */
        }

        /* Send Button */
        .input-area button {
            background-color: var(--primary-button-color);
            color: white;
            border: none;
            border-radius: 0.5rem; /* Slightly rounded */
            padding: 0.75rem; /* Square button */
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            min-width: 2.75rem; /* Match min-height of textarea */
            min-height: 2.75rem;
        }
        .input-area button:hover:not(:disabled) {
            background-color: var(--primary-button-hover);
            transform: translateY(-1px);
        }
        .input-area button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .input-area button svg {
            fill: currentColor;
            width: 1.5rem;
            height: 1.5rem;
        }

        /* File Upload Button */
        .file-input-label {
            background-color: var(--input-bg-color); /* Matches input area background */
            color: var(--placeholder-color); /* Lighter icon */
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.75rem;
            height: 2.75rem;
            flex-shrink: 0;
        }
        .file-input-label:hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .file-input-label input[type="file"] {
            display: none;
        }
        .file-input-label svg {
            fill: currentColor;
            width: 1.5rem;
            height: 1.5rem;
        }

        /* Image Preview Thumbnail */
        .image-preview-thumbnail {
            position: relative;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--primary-button-color);
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            flex-shrink: 0;
            display: none; /* Hidden by default */
        }
        .image-preview-thumbnail.active {
            display: block;
        }
        .image-preview-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-preview-thumbnail .remove-image {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: #EF4444; /* Red for close button */
            color: white;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            transition: transform 0.1s ease;
        }
        .image-preview-thumbnail .remove-image:hover {
            transform: scale(1.1);
        }

        /* Footer (if any, make it simple) */
        .footer-creator {
            background-color: var(--bg-color);
            color: rgba(255, 255, 255, 0.5);
            padding: 0.75rem;
            text-align: center;
            font-size: 0.8em;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container { 
                width: 100%; 
                height: 100vh; /* Full height on mobile */
                border-radius: 0; 
            }
            .header { padding: 0.75rem 1rem; font-size: 1em; }
            .clear-chat-button { padding: 0.4rem 0.6rem; font-size: 0.8em; }
            .clear-chat-button svg { width: 0.9rem; height: 0.9rem; }
            .chat-window { padding: 0.75rem 1rem; font-size: 0.95em; }
            .message-content { max-width: 85%; padding: 0.6rem 0.8rem; }
            .avatar { width: 2rem; height: 2rem; font-size: 0.9em; }
            .input-area { padding: 0.75rem 1rem; gap: 0.6rem; }
            .input-area textarea { padding: 0.6rem 0.8rem; font-size: 0.95em; min-height: 2.5rem; }
            .input-area button, .file-input-label { min-width: 2.5rem; min-height: 2.5rem; padding: 0.6rem; }
            .input-area button svg, .file-input-label svg { width: 1.2rem; height: 1.2rem; }
            .image-preview-thumbnail { width: 3rem; height: 3rem; }
            .footer-creator { font-size: 0.75em; padding: 0.6rem; }
            .loading-logo { font-size: 3em; }
            .loading-text { font-size: 1em; }
        }

        /* Safe area adjustments for notched devices (iPhone X, etc.) */
        @supports(padding: max(0px)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            .loading-screen {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            .container {
                height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">Kynay AI</div>
        <div class="loading-text">Created by Farhan Kertadiwangsa</div>
    </div>

    <div class="container" id="mainContainer">
        <div class="header">
            <h1>Kynay AI</h1>
            <button class="clear-chat-button" id="clearChatButton">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                New Chat
            </button>
        </div>
        <div class="chat-window" id="chatWindow">
            <div class="message ai">
                <div class="avatar">AI</div>
                <div class="message-content">
                    <p>Halo! Saya Kynay AI, asisten virtual Anda. Bagaimana saya bisa membantu Anda hari ini?</p>
                    <span class="attribution">Ditenagai oleh Farhan Kertadiwangsa</span>
                </div>
            </div>
        </div>
        <div class="input-area">
            <label for="imageUpload" class="file-input-label">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm80-120h400L570-480 450-360l-90-120-80 100Zm-80 0v-560 560Z"/></svg>
                <input type="file" id="imageUpload" accept="image/*">
            </label>
            <div class="image-preview-thumbnail" id="imagePreviewThumbnail">
                <img id="imageThumbnail" src="#" alt="Image Preview">
                <span class="remove-image" id="removeImage">&times;</span>
            </div>
            <textarea id="userInput" placeholder="Kirim pesan..." rows="1"></textarea>
            <button id="sendButton" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M120-160v-640l720 320-720 320Zm80-120 472-200-472-200v140l240 60-240 60v140Z"/></svg>
            </button>
        </div>
        <div class="footer-creator">
            Kynay AI - Developed by Farhan Kertadiwangsa
        </div>
    </div>

    <script>
        const loadingScreen = document.getElementById('loadingScreen');
        const mainContainer = document.getElementById('mainContainer');
        const chatWindow = document.getElementById('chatWindow');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const clearChatButton = document.getElementById('clearChatButton');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreviewThumbnail = document.getElementById('imagePreviewThumbnail');
        const imageThumbnail = document.getElementById('imageThumbnail');
        const removeImageButton = document.getElementById('removeImage');

        // URL backend Flask
        const API_URL = 'http://127.0.0.1:5000/ask'; 
        let selectedImageBase64 = null;

        // Fungsi untuk mengadaptasi tinggi textarea
        function autoResizeTextarea() {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
            sendButton.disabled = userInput.value.trim() === '' && selectedImageBase64 === null;
        }

        // Fungsi untuk menambahkan pesan ke jendela chat
        function appendMessage(sender, messageHtml, imageUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);

            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('avatar');
            avatarDiv.textContent = sender === 'ai' ? 'AI' : 'Anda';

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');

            if (imageUrl) {
                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                imgElement.classList.add('message-image-preview');
                contentDiv.appendChild(imgElement);
            }
            
            const textContent = document.createElement('p');
            textContent.innerHTML = messageHtml;
            contentDiv.appendChild(textContent);

            // Tambahkan atribusi untuk pesan AI
            if (sender === 'ai') {
                const attributionSpan = document.createElement('span');
                attributionSpan.classList.add('attribution');
                attributionSpan.textContent = 'Ditenagai oleh Farhan Kertadiwangsa';
                contentDiv.appendChild(attributionSpan);
            }

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Gulir otomatis ke bawah
        }

        // Fungsi untuk menampilkan indikator mengetik
        function showTypingIndicator() {
            const indicatorHtml = `
                <div class="typing-indicator">
                    <span>Kynay sedang mengetik...</span>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            const indicatorDiv = document.createElement('div');
            indicatorDiv.classList.add('message', 'ai', 'typing-message');
            indicatorDiv.innerHTML = `<div class="avatar">AI</div>${indicatorHtml}`;
            chatWindow.appendChild(indicatorDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return indicatorDiv;
        }

        // Fungsi untuk menghapus indikator mengetik
        function hideTypingIndicator(indicatorElement) {
            if (indicatorElement && chatWindow.contains(indicatorElement)) {
                chatWindow.removeChild(indicatorElement);
            }
        }

        // Fungsi untuk mengkonversi gambar ke Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Event listener untuk input file gambar
        imageUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const MAX_FILE_SIZE_MB = 4;
                const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

                if (file.size > MAX_FILE_SIZE_BYTES) {
                    alert(`Maaf, ukuran gambar maksimal adalah ${MAX_FILE_SIZE_MB}MB.`);
                    imageUpload.value = '';
                    imagePreviewThumbnail.classList.remove('active');
                    imageThumbnail.src = '#';
                    selectedImageBase64 = null;
                    sendButton.disabled = true;
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    imageThumbnail.src = e.target.result;
                    imagePreviewThumbnail.classList.add('active');
                    sendButton.disabled = false; // Enable send button when image is selected
                };
                reader.readAsDataURL(file);

                try {
                    selectedImageBase64 = await fileToBase64(file);
                } catch (error) {
                    console.error('Error converting image to base64:', error);
                    selectedImageBase64 = null;
                    alert('Gagal memproses gambar. Mohon coba lagi.');
                    sendButton.disabled = true;
                }
            } else {
                imagePreviewThumbnail.classList.remove('active');
                imageThumbnail.src = '#';
                selectedImageBase64 = null;
                sendButton.disabled = userInput.value.trim() === ''; // Disable if no text
            }
            autoResizeTextarea(); // Adjust textarea height after image selection
        });

        // Event listener untuk tombol hapus gambar
        removeImageButton.addEventListener('click', () => {
            imagePreviewThumbnail.classList.remove('active');
            imageThumbnail.src = '#';
            selectedImageBase64 = null;
            imageUpload.value = '';
            sendButton.disabled = userInput.value.trim() === ''; // Disable if no text
            autoResizeTextarea(); // Adjust textarea height after image removal
        });

        // Event listener untuk perubahan input teks (untuk mengaktifkan/menonaktifkan tombol kirim)
        userInput.addEventListener('input', () => {
            sendButton.disabled = userInput.value.trim() === '' && selectedImageBase64 === null;
            autoResizeTextarea();
        });

        // Fungsi utama untuk menangani input pengguna
        async function handleUserInput() {
            const message = userInput.value.trim();
            if (message === '' && selectedImageBase64 === null) return;

            // Tampilkan pesan pengguna (dan gambar jika ada)
            appendMessage('user', message, imageThumbnail.src !== '#' ? imageThumbnail.src : null); 
            
            userInput.value = ''; // Kosongkan input
            autoResizeTextarea(); // Sesuaikan kembali tinggi textarea
            removeImageButton.click(); // Hapus gambar dari preview setelah dikirim
            sendButton.disabled = true; // Nonaktifkan tombol kirim

            let typingIndicatorElement = showTypingIndicator();

            const postData = {
                query: message,
                image: selectedImageBase64
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.response || `HTTP error! Status: ${response.status}`;
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                hideTypingIndicator(typingIndicatorElement);
                appendMessage('ai', data.response);

            } catch (error) {
                console.error('Error fetching AI response:', error);
                hideTypingIndicator(typingIndicatorElement);
                appendMessage('ai', `Maaf, saya tidak dapat terhubung ke server Kynay atau ada masalah. Error: "${error.message}". Mohon pastikan server Anda berjalan, API Key Gemini benar, dan koneksi internet stabil.`);
            } finally {
                sendButton.disabled = userInput.value.trim() === '' && selectedImageBase64 === null; // Re-enable if there's new input
            }
        }

        sendButton.addEventListener('click', handleUserInput);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) { // Shift+Enter for new line
                event.preventDefault(); // Prevent new line in textarea
                if (!sendButton.disabled) {
                    handleUserInput();
                }
            }
        });

        clearChatButton.addEventListener('click', () => {
            // Hapus semua pesan kecuali pesan sambutan awal
            while (chatWindow.children.length > 1) {
                chatWindow.removeChild(chatWindow.lastChild);
            }
            // Reset input dan gambar preview
            userInput.value = '';
            removeImageButton.click();
            sendButton.disabled = true; // Disable button after clearing
            autoResizeTextarea();
        });

        // Tampilkan layar utama setelah loading
        window.addEventListener('load', () => {
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 1500); // Durasi loading screen

            setTimeout(() => {
                userInput.focus();
                autoResizeTextarea(); // Set initial height for textarea
            }, 1800); // Sedikit jeda setelah loading hilang
        });

        // Panggil autoResizeTextarea saat jendela di-resize juga
        window.addEventListener('resize', autoResizeTextarea);
    </script>
</body>
</html>